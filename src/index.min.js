function loaded(){window.removeEventListener('load',loaded,!1),_DOMReady=!0;}function ath(a){return _instance=_instance||new ath.Class(a),_instance;}function _extend(b,c){for(var a in c)b[a]=c[a];return b;}function _removeToken(){document.location.hash=='#ath'&&history.replaceState('',window.document.title,document.location.href.split('#')[0]),_reSmartURL.test(document.location.href)&&history.replaceState('',window.document.title,document.location.href.replace(_reSmartURL,'$1')),_reQueryString.test(document.location.search)&&history.replaceState('',window.document.title,document.location.href.replace(_reQueryString,'$2'));}var _eventListener='addEventListener'in window;var _DOMReady=!1;document.readyState==='complete'?_DOMReady=!0:_eventListener&&window.addEventListener('load',loaded,!1);var _reSmartURL=/\/ath(\/)?$/;var _reQueryString=/([\?&]ath=[^&]*$|&ath=[^&]*(&))/;var _instance;ath.defaults={appID:'add_to_homescreen',fontSize:15,debug:!1,logging:!1,modal:!1,mandatory:!1,autostart:!0,skipFirstVisit:!1,startDelay:1,lifespan:15,displayPace:1440,maxDisplayCount:0,icon:!0,message:'',validLocation:[],onInit:null,onShow:null,onRemove:null,onAdd:null,onPrivate:null,privateModeOverride:!1,detectHomescreen:!1,iosText:'pica',androidText:'devka'};var _ua=window.navigator.userAgent;_extend(ath,{hasToken:document.location.hash=='#ath'||_reSmartURL.test(document.location.href)||_reQueryString.test(document.location.search),isIDevice:/iphone|ipod|ipad/i.test(_ua),isMobileChrome:_ua.indexOf('Android')>-1&&/Chrome\/[.0-9]*/.test(_ua)&&_ua.indexOf('Version')==-1}),ath.isMobileSafari=ath.isIDevice&&_ua.indexOf('Safari')>-1&&_ua.indexOf('CriOS')<0,ath.OS=ath.isIDevice?'ios':ath.isMobileChrome?'android':ath.isMobileIE?'windows':'unsupported',ath.OSVersion=_ua.match(/(OS|Android) (\d+[_\.]\d+)/),ath.OSVersion=ath.OSVersion&&ath.OSVersion[2]?+ath.OSVersion[2].replace('_','.'):0,ath.isStandalone='standalone'in window.navigator&&window.navigator.standalone,ath.isTablet=ath.isMobileSafari&&_ua.indexOf('iPad')>-1||ath.isMobileChrome&&_ua.indexOf('Mobile')<0,ath.isCompatible=ath.isMobileSafari&&ath.OSVersion>=6||ath.isMobileChrome;var _defaultSession={lastDisplayTime:0,returningVisitor:!1,displayCount:0,optedout:!1,added:!1};ath.removeSession=function(a){try{if(!localStorage)throw new Error('localStorage is not defined');localStorage.removeItem(a||ath.defaults.appID);}catch(e){}},ath.doLog=function(a){this.options.logging&&console.log(a);},ath.Class=function(c){if(this.doLog=ath.doLog,this.options=_extend({},ath.defaults),_extend(this.options,c),this.options&&this.options.debug&&this.options.logging===void 0&&(this.options.logging=!0),!_eventListener)return;if(this.options.mandatory=this.options.mandatory&&('standalone'in window.navigator||this.options.debug),this.options.modal=this.options.modal||this.options.mandatory,this.options.mandatory&&(this.options.startDelay=-0.5),this.options.detectHomescreen=this.options.detectHomescreen===!0?'hash':this.options.detectHomescreen,this.options.debug&&(ath.isCompatible=!0,ath.OS=typeof this.options.debug=='string'?this.options.debug:ath.OS=='unsupported'?'android':ath.OS,ath.OSVersion=ath.OS=='ios'?'8':'4'),this.container=document.body,this.session=this.getItem(this.options.appID),this.session=this.session?JSON.parse(this.session):undefined,ath.hasToken&&!(ath.isCompatible&&this.session)&&(ath.hasToken=!1,_removeToken()),!ath.isCompatible){this.doLog('Device not supported');return;}this.session=this.session||_defaultSession;try{if(!localStorage)throw new Error('localStorage is not defined');localStorage.setItem(this.options.appID,JSON.stringify(this.session)),ath.hasLocalStorage=!0;}catch(e){ath.hasLocalStorage=false;if(this.options.onPrivate){this.options.onPrivate.call(this);}}var a=!this.options.validLocation.length;for(var b=this.options.validLocation.length;b--;)if(this.options.validLocation[b].test(document.location.href)){a=!0;break;}if(this.session.optedout){this.doLog('User opt out');return;}if(this.session.added){this.doLog('Already added');return;}if(!a){this.doLog('Invalid location');return;}if(ath.isStandalone){this.session.added||(this.session.added=!0,this.updateSession(),this.options.onAdd&&ath.hasLocalStorage&&this.options.onAdd.call(this)),this.doLog('Standalone mode');return;}if(this.options.detectHomescreen){if(ath.hasToken){_removeToken(),this.session.added||(this.session.added=!0,this.updateSession(),this.options.onAdd&&ath.hasLocalStorage&&this.options.onAdd.call(this)),this.doLog('PWA');return;}this.options.detectHomescreen=='hash'?history.replaceState('',window.document.title,document.location.href+'#ath'):this.options.detectHomescreen=='smartURL'?history.replaceState('',window.document.title,document.location.href.replace(/(\/)?$/,'/ath$1')):history.replaceState('',window.document.title,document.location.href+(document.location.search?'&':'?')+'ath=');}if(!this.session.returningVisitor&&(this.session.returningVisitor=!0,this.updateSession(),this.options.skipFirstVisit)){this.doLog('First visit');return;}if(!(this.options.privateModeOverride||ath.hasLocalStorage)){this.doLog('Private mode');return;}this.ready=!0,this.options.onInit&&this.options.onInit.call(this),this.options.autostart&&(this.doLog('Autostart'),this.show());},ath.Class.prototype={events:{load:'_delayedShow',error:'_delayedShow',orientationchange:'resize',resize:'resize',scroll:'resize',click:'remove',touchmove:'_preventDefault',transitionend:'_removeElements',webkitTransitionEnd:'_removeElements',MSTransitionEnd:'_removeElements'},handleEvent:function(b){var a=this.events[b.type];a&&this[a](b);},show:function(d){if(this.options.autostart&&!_DOMReady){setTimeout(this.show.bind(this),50);return;}if(this.shown){this.doLog('Already shown');return;}var b=Date.now();var c=this.session.lastDisplayTime;if(d!==!0){if(!this.ready){this.doLog('Not ready');return;}if(b-c<this.options.displayPace*60000){this.doLog('Displayed recently');return;}if(this.options.maxDisplayCount&&this.session.displayCount>=this.options.maxDisplayCount){this.doLog('Display limit reached');return;}}this.shown=!0,this.session.lastDisplayTime=b,this.session.displayCount++,this.updateSession(),this.applicationIcon||(ath.OS=='ios'?this.applicationIcon=document.querySelector('head link[rel^=apple-touch-icon][sizes="152x152"],head link[rel^=apple-touch-icon][sizes="144x144"],head link[rel^=apple-touch-icon][sizes="120x120"],head link[rel^=apple-touch-icon][sizes="114x114"],head link[rel^=apple-touch-icon]'):this.applicationIcon=document.querySelector('head link[rel^="shortcut icon"][sizes="196x196"],head link[rel^=apple-touch-icon]'));var a='';ath.OS==='android'?a=this.options.androidText:ath.OS==='ios'&&(a=this.options.iosText),a='<p>'+a.replace(/%icon(?:\[([^\]]+)\])?/gi,function(b,a){return'<span class="ath-action-icon">'+(a?a:'icon')+'</span>';})+'</p>',this.viewport=document.createElement('div'),this.viewport.className='ath-viewport',this.options.modal&&(this.viewport.className+=' ath-modal'),this.options.mandatory&&(this.viewport.className+=' ath-mandatory'),this.viewport.style.position='absolute',this.element=document.createElement('div'),this.element.className='ath-container ath-'+ath.OS+' ath-'+ath.OS+' ath-'+(ath.isTablet?'tablet':'phone'),this.element.style.cssText='-webkit-transition-property:-webkit-transform,opacity;-webkit-transition-duration:0s;-webkit-transition-timing-function:ease-out;transition-property:transform,opacity;transition-duration:0s;transition-timing-function:ease-out;',this.element.style.webkitTransform='translate3d(0,-'+window.innerHeight+'px,0)',this.element.style.transform='translate3d(0,-'+window.innerHeight+'px,0)',this.options.icon&&this.applicationIcon&&(this.element.className+=' ath-icon',this.img=document.createElement('img'),this.img.className='ath-application-icon',this.img.addEventListener('load',this,!1),this.img.addEventListener('error',this,!1),this.img.src=this.applicationIcon.href,this.element.appendChild(this.img)),this.element.innerHTML+=a,this.viewport.style.left='-99999em',this.viewport.appendChild(this.element),this.container.appendChild(this.viewport),this.img?this.doLog('Add to homescreen: not displaying callout because waiting for img to load'):this._delayedShow();},_delayedShow:function(a){setTimeout(this._show.bind(this),this.options.startDelay*1000+500);},_show:function(){var a=this;this.updateViewport(),window.addEventListener('resize',this,!1),window.addEventListener('scroll',this,!1),window.addEventListener('orientationchange',this,!1),this.options.modal&&document.addEventListener('touchmove',this,!0),this.options.mandatory||setTimeout(function(){a.element.addEventListener('click',a,!0);},1000),setTimeout(function(){a.element.style.webkitTransitionDuration='1.2s',a.element.style.transitionDuration='1.2s',a.element.style.webkitTransform='translate3d(0,0,0)',a.element.style.transform='translate3d(0,0,0)';},0),this.options.lifespan&&(this.removeTimer=setTimeout(this.remove.bind(this),this.options.lifespan*1000)),this.options.onShow&&this.options.onShow.call(this);},remove:function(){clearTimeout(this.removeTimer),this.img&&(this.img.removeEventListener('load',this,!1),this.img.removeEventListener('error',this,!1)),window.removeEventListener('resize',this,!1),window.removeEventListener('scroll',this,!1),window.removeEventListener('orientationchange',this,!1),document.removeEventListener('touchmove',this,!0),this.element.removeEventListener('click',this,!0),this.element.addEventListener('transitionend',this,!1),this.element.addEventListener('webkitTransitionEnd',this,!1),this.element.addEventListener('MSTransitionEnd',this,!1),this.element.style.webkitTransitionDuration='0.3s',this.element.style.opacity='0';},_removeElements:function(){this.element.removeEventListener('transitionend',this,!1),this.element.removeEventListener('webkitTransitionEnd',this,!1),this.element.removeEventListener('MSTransitionEnd',this,!1),this.container.removeChild(this.viewport),this.shown=!1,this.options.onRemove&&this.options.onRemove.call(this);},updateViewport:function(){if(!this.shown)return;this.viewport.style.width=window.innerWidth+'px',this.viewport.style.height=window.innerHeight+'px',this.viewport.style.left=window.scrollX+'px',this.viewport.style.top=window.scrollY+'px';var a=document.documentElement.clientWidth;this.orientation=a>document.documentElement.clientHeight?'landscape':'portrait';var b=ath.OS=='ios'?this.orientation=='portrait'?screen.width:screen.height:screen.width;this.scale=screen.width>a?1:b/window.innerWidth,this.element.style.fontSize=this.options.fontSize/this.scale+'px';},resize:function(){clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(this.updateViewport.bind(this),100);},updateSession:function(){if(ath.hasLocalStorage===!1)return;localStorage&&localStorage.setItem(this.options.appID,JSON.stringify(this.session));},clearSession:function(){this.session=_defaultSession,this.updateSession();},getItem:function(a){try{if(!localStorage)throw new Error('localStorage is not defined');return localStorage.getItem(a);}catch(e){ath.hasLocalStorage=false;}},optOut:function(){this.session.optedout=!0,this.updateSession();},optIn:function(){this.session.optedout=!1,this.updateSession();},clearDisplayCount:function(){this.session.displayCount=0,this.updateSession();},_preventDefault:function(a){a.preventDefault(),a.stopPropagation();}},module.exports={addToHomescreen:ath};